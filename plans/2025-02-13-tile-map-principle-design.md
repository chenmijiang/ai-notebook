# 瓦片地图原理

> L7 学习前置知识 — 理解 XYZ 瓦片分层机制、瓦片金字塔、矢量瓦片与栅格瓦片的区别

## 为什么需要瓦片地图

想象你要在网页上显示一张世界地图。如果把整张地图作为一张图片加载，会遇到两个问题：

**问题 1：数据量巨大**

一张覆盖全球、细节到街道级别的地图，如果做成单张图片，可能需要数百 GB 甚至 TB 级别的存储。用户不可能等待这么大的文件下载完成。

**问题 2：大部分数据是浪费的**

用户在某一时刻只关注地图的一小块区域。当你查看北京的街道时，并不需要加载纽约的数据。

**瓦片地图的解决思路**：

- 把地图切成小块（瓦片），每块通常是 256×256 或 512×512 像素
- 只加载用户当前视野内的瓦片
- 根据缩放级别，提供不同精度的瓦片

这就像看报纸：你不会一次把整份报纸摊开，而是翻到你想看的那一页。

---

## 瓦片金字塔 — 分层的核心思想

瓦片金字塔是整个瓦片地图的核心数据结构。

### 基本原理

把同一区域的地图，按不同的精细程度，预先渲染成多个层级。每个层级的瓦片数量不同：

```
层级 0（最粗）：整个世界 = 1 张瓦片
层级 1：整个世界 = 4 张瓦片（2×2）
层级 2：整个世界 = 16 张瓦片（4×4）
层级 3：整个世界 = 64 张瓦片（8×8）
...
层级 n：整个世界 = 4^n 张瓦片
```

### 为什么叫"金字塔"

从侧面看，层级越低，瓦片越少（塔尖）；层级越高，瓦片越多（塔底）。形状像金字塔。

```
        ┌───┐
        │ 0 │           ← 1 张瓦片，看到整个世界的轮廓
        └───┘
      ┌──┬──┐
      │  │  │
      ├──┼──┤           ← 4 张瓦片，能分辨大洲
      │  │  │
      └──┴──┘
   ┌──┬──┬──┬──┐
   │  │  │  │  │
   ├──┼──┼──┼──┤        ← 16 张瓦片，能分辨国家
   │  │  │  │  │
   └──┴──┴──┴──┘
        ...
```

### 缩放与层级的关系

- 用户缩小地图（看全局）→ 加载低层级的瓦片（数量少，细节少）
- 用户放大地图（看细节）→ 加载高层级的瓦片（数量多，细节多）

常见的瓦片服务提供 0-18 或 0-22 级。第 18 级大约能看清单栋建筑，第 22 级能看清地面的车道线。

---

## XYZ 坐标系统 — 如何定位每一块瓦片

知道了金字塔有多少层级后，下一个问题是：如何唯一标识每一块瓦片？

### XYZ 三个参数

- **Z（Zoom）**：层级，决定精细程度
- **X**：横向位置，从左到右，从 0 开始
- **Y**：纵向位置，从上到下，从 0 开始（也有从下到上的变体，如 TMS）

```
Z = 1 时的瓦片编号：

     X=0    X=1
   ┌──────┬──────┐
   │      │      │
   │ 0,0  │ 1,0  │  Y=0
   │      │      │
   ├──────┼──────┤
   │      │      │
   │ 0,1  │ 1,1  │  Y=1
   │      │      │
   └──────┴──────┘
```

### 坐标范围与层级的关系

- Z=0 时：X 和 Y 都只能是 0（只有 1 块瓦片）
- Z=1 时：X 和 Y 的范围是 0-1（共 4 块）
- Z=n 时：X 和 Y 的范围是 0 到 2^n - 1

### 瓦片 URL 的典型格式

```
https://tile.example.com/{z}/{x}/{y}.png
```

比如请求 `https://tile.example.com/3/4/2.png`，就是获取第 3 层级、横向第 4 块、纵向第 2 块的瓦片图片。

### 经纬度如何转换为 XYZ

地图库（如 Leaflet、L7）内部会根据：

1. 当前的缩放级别 → 确定 Z
2. 视野中心的经纬度 + Web Mercator 投影 → 计算出对应的 X、Y

这个转换依赖 Web Mercator 投影（EPSG:3857），将球面经纬度映射到平面坐标系。

---

## 栅格瓦片 vs 矢量瓦片

瓦片机制有两种技术实现路线。

### 栅格瓦片（Raster Tiles）

本质是**图片**。服务端预先把地图渲染成 PNG/JPG/WebP 格式的图片，客户端直接显示。

```
服务端                        客户端

地理数据 → 渲染成图片 → 传输 → 直接显示

优点：客户端计算量小，兼容性好
缺点：样式固定，无法交互查询单个要素
```

典型场景：卫星影像、地形图、传统底图

### 矢量瓦片（Vector Tiles）

本质是**数据**。服务端传输的是压缩后的几何数据（点、线、面）和属性，客户端负责渲染。

```
服务端                        客户端

地理数据 → 切片+压缩 → 传输 → 解析+渲染

优点：样式可动态调整，支持要素级交互
缺点：客户端需要 GPU 渲染能力
```

典型场景：可交互的地图（点击查询）、自定义样式底图

### 对比总结

| 维度     | 栅格瓦片       | 矢量瓦片              |
| -------- | -------------- | --------------------- |
| 传输内容 | 图片           | 几何数据 + 属性       |
| 渲染位置 | 服务端         | 客户端                |
| 文件格式 | PNG/JPG/WebP   | PBF (Protocol Buffer) |
| 样式修改 | 需重新生成瓦片 | 客户端即时修改        |
| 要素交互 | 不支持         | 支持（如点击高亮）    |
| 典型代表 | 传统地图服务   | Mapbox、MapLibre      |

---

## 与 L7 的关联

理解瓦片地图原理后，在 L7 源码中会遇到以下相关内容：

- **Source 包**：支持 MVT（Mapbox Vector Tile）格式的解析，位于 `packages/source/`
- **TileLayer**：针对瓦片做了按需加载和回收的优化，避免内存溢出
- **坐标转换**：L7 的 CoordinateSystemService 处理经纬度与瓦片坐标的转换

---

## 总结

| 概念       | 核心要点                                             |
| ---------- | ---------------------------------------------------- |
| 瓦片地图   | 将地图切成小块，按需加载，解决大数据量传输问题       |
| 瓦片金字塔 | 多层级预渲染，不同缩放级别使用不同精度的瓦片         |
| XYZ 坐标   | Z 决定层级，X/Y 定位具体瓦片，URL 格式 `{z}/{x}/{y}` |
| 栅格瓦片   | 传输图片，服务端渲染，样式固定                       |
| 矢量瓦片   | 传输数据，客户端渲染，支持动态样式和交互             |
